<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>어드벤처 게임</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: #f0f0f0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    #game-container {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      width: 100%;
      height: 100%;
    }
    #left-panel {
      flex: 3;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    #dialogue {
      flex: 1;
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    #choices {
      margin-top: 20px;
    }
    .choice-btn {
      display: block;
      margin: 10px 0;
      padding: 10px;
      background: #444;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    .choice-btn:hover {
      background: #666;
    }
    #right-panel {
      flex: 1;
      background: #111;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #heroImg {
      width: 200px;
      height: 260px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #444;
    }
    #affection {
      margin-top: 20px;
      font-size: 14px;
      color: #bbb;
    }
  </style>
  <!-- 파비콘 (투명 1x1) -->
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=">
</head>
<body>
  <div id="game-container">
    <div id="left-panel">
      <div id="dialogue"></div>
      <div id="choices"></div>
    </div>
    <div id="right-panel">
      <!-- 기본 placeholder 이미지 -->
      <img id="heroImg" alt="heroine"
           src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='260'%3E%3Crect width='100%25' height='100%25' fill='%23151a22'/%3E%3Ctext x='50%25' y='50%25' fill='%236b7482' font-size='14' text-anchor='middle' dominant-baseline='middle'%3Eheroine%3C/text%3E%3C/svg%3E">
      <div id="affection">호감도 단계: 1/10</div>
    </div>
  </div>

  <script>
    let scenario = null;
    let currentScene = "scene1";
    let affectionLevel = 1;

    async function loadScenario() {
      try {
        const response = await fetch("scenario_full.json");
        if (!response.ok) throw new Error("시나리오 로드 실패");
        scenario = await response.json();
        startScene(currentScene);
      } catch (e) {
        document.getElementById("dialogue").innerText = "시나리오를 불러올 수 없습니다.";
        console.error(e);
      }
    }

    function typeWriter(text, callback) {
      const dialogueDiv = document.getElementById("dialogue");
      dialogueDiv.innerHTML = "";
      let i = 0;
      function typing() {
        if (i < text.length) {
          dialogueDiv.innerHTML += text.charAt(i);
          i++;
          setTimeout(typing, 30);
        } else if (callback) {
          callback();
        }
      }
      typing();
    }

    function startScene(sceneId) {
      const scene = scenario[sceneId];
      if (!scene) {
        document.getElementById("dialogue").innerText = "더 이상 진행할 수 없습니다.";
        return;
      }
      typeWriter(scene.narration + "\n\n" + scene.dialogue.join("\n"), () => {
        showChoices(scene.choices);
      });
    }

    function showChoices(choices) {
      const choicesDiv = document.getElementById("choices");
      choicesDiv.innerHTML = "";
      choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.innerText = choice.text;
        btn.className = "choice-btn";
        btn.onclick = () => {
          affectionLevel = Math.min(10, Math.max(1, affectionLevel + (choice.affection || 0)));
          updateAffection();
          // 1초 후 그녀의 반응 출력
          setTimeout(() => {
            typeWriter("(" + choice.reaction + ")", () => {
              setTimeout(() => {
                currentScene = choice.next;
                startScene(currentScene);
              }, 1000);
            });
          }, 1000);
        };
        choicesDiv.appendChild(btn);
      });
    }

    function updateAffection() {
      const affectionDiv = document.getElementById("affection");
      affectionDiv.innerText = "호감도 단계: " + affectionLevel + "/10";
    }

    // heroine.png 파일이 있으면 자동 교체
    (async function trySwapHeroine(){
      try{
        const res = await fetch("heroine.png", { method:"HEAD", cache:"no-cache" });
        if(res.ok){ document.getElementById("heroImg").src = "heroine.png"; }
      }catch(e){ /* 없으면 기본 이미지 유지 */ }
    })();

    window.onload = loadScenario;
  </script>
</body>
</html>
